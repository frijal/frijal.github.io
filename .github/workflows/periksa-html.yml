name: üìã Validasi SEO, Heading & Struktur HTML

on:
  push:
    branches:
      - main
    paths:
      - '**.html'
      - '_headers'
      - '_redirects'
      - '*.webmanifest'
  workflow_dispatch:

jobs:
  validasi:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout kode
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install HTMLHint
        run: npm install -g htmlhint

      - name: Buat folder mini/
        run: mkdir -p mini

      - name: Validasi HTML & SEO Lengkap
        run: |
          TANGGAL=$(date +%Y%m%d)
          LAPORAN="mini/laporan-validasi-$TANGGAL.txt"
          echo "üìã Laporan Validasi HTML & SEO" > $LAPORAN
          echo "Tanggal: $(date)" >> $LAPORAN
          echo "----------------------------------------" >> $LAPORAN

          for file in $(find . -name "*.html"); do
            echo "‚û°Ô∏è File: $file" >> $LAPORAN

            # Metadata SEO
            grep -q '<meta name="description"' "$file" && echo "‚úÖ description OK" >> $LAPORAN || echo "‚ùå description MISSING" >> $LAPORAN
            grep -q '<meta property="og:title"' "$file" && echo "‚úÖ og:title OK" >> $LAPORAN || echo "‚ùå og:title MISSING" >> $LAPORAN
            grep -q '<meta property="og:image"' "$file" && echo "‚úÖ og:image OK" >> $LAPORAN || echo "‚ùå og:image MISSING" >> $LAPORAN
            grep -q '<meta property="og:description"' "$file" && echo "‚úÖ og:description OK" >> $LAPORAN || echo "‚ùå og:description MISSING" >> $LAPORAN
            grep -q '<meta name="twitter:title"' "$file" && echo "‚úÖ twitter:title OK" >> $LAPORAN || echo "‚ùå twitter:title MISSING" >> $LAPORAN
            grep -q '<meta name="twitter:image"' "$file" && echo "‚úÖ twitter:image OK" >> $LAPORAN || echo "‚ùå twitter:image MISSING" >> $LAPORAN
            grep -q '<meta name="twitter:description"' "$file" && echo "‚úÖ twitter:description OK" >> $LAPORAN || echo "‚ùå twitter:description MISSING" >> $LAPORAN
            grep -q '<link rel="canonical"' "$file" && echo "‚úÖ Canonical URL OK" >> $LAPORAN || echo "‚ùå Canonical URL MISSING" >> $LAPORAN

            # Struktur Umum
            grep -q '<title>' "$file" && echo "‚úÖ <title> OK" >> $LAPORAN || echo "‚ùå <title> MISSING" >> $LAPORAN
            grep -q '<html lang=' "$file" && echo "‚úÖ <html lang> OK" >> $LAPORAN || echo "‚ùå <html lang> MISSING" >> $LAPORAN
            grep -q '<meta charset=' "$file" && echo "‚úÖ <meta charset> OK" >> $LAPORAN || echo "‚ùå <meta charset> MISSING" >> $LAPORAN
            grep -q '<head>' "$file" && echo "‚úÖ <head> OK" >> $LAPORAN || echo "‚ùå <head> MISSING" >> $LAPORAN
            grep -q '<body>' "$file" && echo "‚úÖ <body> OK" >> $LAPORAN || echo "‚ùå <body> MISSING" >> $LAPORAN

            # Struktur Heading
            H1_COUNT=$(grep -o '<h1>' "$file" | wc -l)
            if [ "$H1_COUNT" -eq 1 ]; then
              echo "‚úÖ Satu <h1> ditemukan" >> $LAPORAN
            elif [ "$H1_COUNT" -gt 1 ]; then
              echo "‚ö†Ô∏è Duplikat <h1> ditemukan ($H1_COUNT)" >> $LAPORAN
            else
              echo "‚ùå <h1> tidak ditemukan" >> $LAPORAN
            fi

            # Urutan heading
            HEADINGS=$(grep -o '<h[1-6]>' "$file" | sed 's/<h\([1-6]\)>/\1/' | paste -sd " " -)
            echo "üìä Urutan heading: $HEADINGS" >> $LAPORAN

            echo "----------------------------------------" >> $LAPORAN
          done

      - name: Linting HTML
        run: |
          TANGGAL=$(date +%Y%m%d)
          LAPORAN="mini/laporan-validasi-$TANGGAL.txt"
          echo "üßº Linting HTML dengan HTMLHint..." >> $LAPORAN
          htmlhint "**/*.html" >> $LAPORAN || echo "‚ö†Ô∏è Ada peringatan dari HTMLHint." >> $LAPORAN
          echo "‚úÖ Linting selesai." >> $LAPORAN
